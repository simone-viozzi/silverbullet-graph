var U=Object.defineProperty;var m=(e,t)=>{for(var o in t)U(e,o,{get:t[o],enumerable:!0})};var P=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var C=new Map,x=0;function f(e){self.postMessage(e)}P&&(globalThis.syscall=async(e,...t)=>await new Promise((o,n)=>{x++,C.set(x,{resolve:o,reject:n}),f({type:"sys",id:x,name:e,args:t})}));function b(e,t){P&&(self.addEventListener("message",o=>{(async()=>{let n=o.data;switch(n.type){case"inv":{let s=e[n.name];if(!s)throw new Error(`Function not loaded: ${n.name}`);try{let l=await Promise.resolve(s(...n.args||[]));f({type:"invr",id:n.id,result:l})}catch(l){console.error("An exception was thrown as a result of invoking function",n.name,"error:",l.message),f({type:"invr",id:n.id,error:l.message})}}break;case"sysr":{let s=n.id,l=C.get(s);if(!l)throw Error("Invalid request id");C.delete(s),n.error?l.reject(new Error(n.error)):l.resolve(n.result)}break}})().catch(console.error)}),f({type:"manifest",manifest:t}))}function E(e){let t=atob(e),o=t.length,n=new Uint8Array(o);for(let s=0;s<o;s++)n[s]=t.charCodeAt(s);return n}function w(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",o=e.byteLength;for(let n=0;n<o;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function j(e,t){if(typeof e!="string"){let o=new Uint8Array(await e.arrayBuffer()),n=o.length>0?w(o):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function Y(){globalThis.fetch=async function(e,t){let o=t&&t.body?w(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await j(e,t&&{method:t.method,headers:t.headers,base64Body:o});return new Response(n.base64Body?E(n.base64Body):null,{status:n.status,headers:n.headers})}}P&&Y();var u={};m(u,{confirm:()=>xe,copyToClipboard:()=>Se,deleteLine:()=>Fe,dispatch:()=>ye,downloadFile:()=>ie,filterBox:()=>ce,flashNotification:()=>ae,fold:()=>Ie,foldAll:()=>be,getCurrentPage:()=>N,getCursor:()=>V,getSelection:()=>J,getText:()=>B,getUiOption:()=>Ce,goHistory:()=>ne,hidePanel:()=>ge,insertAtCursor:()=>fe,insertAtPos:()=>ue,moveCursor:()=>de,moveCursorToLine:()=>me,navigate:()=>q,newWindow:()=>oe,openCommandPalette:()=>$,openPageNavigator:()=>z,openSearchPanel:()=>Ke,openUrl:()=>re,prompt:()=>he,redo:()=>ke,reloadConfigAndCommands:()=>te,reloadPage:()=>_,reloadUI:()=>ee,replaceRange:()=>pe,save:()=>H,setSelection:()=>X,setText:()=>O,setUiOption:()=>Pe,showPanel:()=>le,toggleFold:()=>ve,undo:()=>Ge,unfold:()=>Ae,unfoldAll:()=>we,uploadFile:()=>se,vimEx:()=>Ze});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function N(){return r("editor.getCurrentPage")}function B(){return r("editor.getText")}function O(e,t=!1){return r("editor.setText",e,t)}function V(){return r("editor.getCursor")}function J(){return r("editor.getSelection")}function X(e,t){return r("editor.setSelection",e,t)}function H(){return r("editor.save")}function q(e,t=!1,o=!1){return r("editor.navigate",e,t,o)}function z(e="page"){return r("editor.openPageNavigator",e)}function $(){return r("editor.openCommandPalette")}function _(){return r("editor.reloadPage")}function ee(){return r("editor.reloadUI")}function te(){return r("editor.reloadConfigAndCommands")}function re(e,t=!1){return r("editor.openUrl",e,t)}function oe(){return r("editor.newWindow")}function ne(e){return r("editor.goHistory",e)}function ie(e,t){return r("editor.downloadFile",e,t)}function se(e,t){return r("editor.uploadFile",e,t)}function ae(e,t="info"){return r("editor.flashNotification",e,t)}function ce(e,t,o="",n=""){return r("editor.filterBox",e,t,o,n)}function le(e,t,o,n=""){return r("editor.showPanel",e,t,o,n)}function ge(e){return r("editor.hidePanel",e)}function ue(e,t){return r("editor.insertAtPos",e,t)}function pe(e,t,o){return r("editor.replaceRange",e,t,o)}function de(e,t=!1){return r("editor.moveCursor",e,t)}function me(e,t=1,o=!1){return r("editor.moveCursorToLine",e,t,o)}function fe(e){return r("editor.insertAtCursor",e)}function ye(e){return r("editor.dispatch",e)}function he(e,t=""){return r("editor.prompt",e,t)}function xe(e){return r("editor.confirm",e)}function Ce(e){return r("editor.getUiOption",e)}function Pe(e,t){return r("editor.setUiOption",e,t)}function Ie(){return r("editor.fold")}function Ae(){return r("editor.unfold")}function ve(){return r("editor.toggleFold")}function be(){return r("editor.foldAll")}function we(){return r("editor.unfoldAll")}function Ge(){return r("editor.undo")}function ke(){return r("editor.redo")}function Ke(){return r("editor.openSearchPanel")}function Se(e){return r("editor.copyToClipboard",e)}function Fe(){return r("editor.deleteLine")}function Ze(e){return r("editor.vimEx",e)}var d={};m(d,{applyAttributeExtractors:()=>Ue,getEnv:()=>Ne,getMode:()=>Be,getSpaceConfig:()=>Ee,getVersion:()=>Oe,invokeCommand:()=>Le,invokeFunction:()=>We,invokeSpaceFunction:()=>Qe,listCommands:()=>Te,listSyscalls:()=>De,reloadConfig:()=>Ye,reloadPlugs:()=>je});function We(e,...t){return r("system.invokeFunction",e,...t)}function Le(e,t){return r("system.invokeCommand",e,t)}function Te(){return r("system.listCommands")}function De(){return r("system.listSyscalls")}function Qe(e,...t){return r("system.invokeSpaceFunction",e,...t)}function Ue(e,t,o){return r("system.applyAttributeExtractors",e,t,o)}async function Ee(e,t){return await r("system.getSpaceConfig",e)??t}function je(){return r("system.reloadPlugs")}function Ye(){return r("system.reloadConfig")}function Ne(){return r("system.getEnv")}function Be(){return r("system.getMode")}function Oe(){return r("system.getVersion")}var y={};m(y,{readAsset:()=>_e});function $e(e){let t=atob(e),o=t.length,n=new Uint8Array(o);for(let s=0;s<o;s++)n[s]=t.charCodeAt(s);return n}function G(e){let t=e.split(",",2)[1];return $e(t)}async function _e(e,t,o="utf8"){let n=await r("asset.readAsset",e,t);switch(o){case"utf8":return new TextDecoder().decode(G(n));case"dataurl":return n}}var p={};m(p,{batchDel:()=>lt,batchGet:()=>at,batchSet:()=>it,del:()=>ct,get:()=>st,listFunctions:()=>pt,query:()=>gt,queryDelete:()=>ut,set:()=>nt});function nt(e,t){return r("datastore.set",e,t)}function it(e){return r("datastore.batchSet",e)}function st(e){return r("datastore.get",e)}function at(e){return r("datastore.batchGet",e)}function ct(e){return r("datastore.delete",e)}function lt(e){return r("datastore.batchDelete",e)}function gt(e,t={}){return r("datastore.query",e,t)}function ut(e,t){return r("datastore.queryDelete",e,t)}function pt(){return r("datastore.listFunctions")}var ft=Object.create,A=Object.defineProperty,yt=Object.getOwnPropertyDescriptor,ht=Object.getOwnPropertyNames,xt=Object.getPrototypeOf,Ct=Object.prototype.hasOwnProperty,Pt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),It=(e,t)=>{for(var o in t)A(e,o,{get:t[o],enumerable:!0})},I=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of ht(t))!Ct.call(e,s)&&s!==o&&A(e,s,{get:()=>t[s],enumerable:!(n=yt(t,s))||n.enumerable});return e},At=(e,t,o)=>(I(e,t,"default"),o&&I(o,t,"default")),K=(e,t,o)=>(o=e!=null?ft(xt(e)):{},I(t||!e||!e.__esModule?A(o,"default",{value:e,enumerable:!0}):o,e)),S=Pt(e=>{e.compile=function(l){var c=e.parse(l),g=c[0],i=c[1];return{accepts:function(a){return a[0]==="/"&&(a=a.slice(1)),i[0].test(a)||!g[0].test(a)},denies:function(a){return a[0]==="/"&&(a=a.slice(1)),!(i[0].test(a)||!g[0].test(a))},maybe:function(a){return a[0]==="/"&&(a=a.slice(1)),i[1].test(a)||!g[1].test(a)}}},e.parse=function(l){return l.split(`
`).map(function(c){return c=c.trim(),c}).filter(function(c){return c&&c[0]!=="#"}).reduce(function(c,g){var i=g[0]==="!";return i&&(g=g.slice(1)),g[0]==="/"&&(g=g.slice(1)),i?c[1].push(g):c[0].push(g),c},[[],[]]).map(function(c){return c.sort().map(t).reduce(function(g,i){return g[0].push(i[0]),g[1].push(i[1]),g},[[],[],[]])}).map(function(c){return[c[0].length>0?new RegExp("^(("+c[0].join(")|(")+"))"):new RegExp("$^"),c[1].length>0?new RegExp("^(("+c[1].join(")|(")+"))"):new RegExp("$^")]})};function t(l){return[o(l),n(l)]}function o(l){return s(l).replace("**","(.+)").replace("*","([^\\/]+)")}function n(l){return l.split("/").map(function(c,g){return g?"([\\/]?("+o(c)+"\\b|$))":"("+o(c)+"\\b)"}).join("")}function s(l){return l.replace(/[\-\[\]\/\{\}\(\)\+\?\.\\\^\$\|]/g,"\\$&")}}),F={};It(F,{compile:()=>v,default:()=>R,parse:()=>vt});var Z=K(S());At(F,K(S()));var{compile:v,parse:vt}=Z,{default:k,...bt}=Z,R=k!==void 0?k:bt;async function wt(){let e=await d.getSpaceConfig(),t=e.graph?.excludeRegex||[],o=e.graph?.excludeTags||[],n=v(t.join(`
`)).accepts;return console.log("Compiled fileFilterFn:",n),console.log("Exclude Tags:",o),{fileFilterFn:n,excludeTags:o}}async function M(){let{fileFilterFn:e,excludeTags:t}=await wt(),o=await d.invokeFunction("index.queryObjects","page");console.log("pages ok");let n=o.filter(i=>e(i.name)&&!i.tags.some(a=>t.includes(a)));console.log("pages filtered");let s=await p.query({type:"link"});console.log("link ok");let l=s.filter(i=>{try{let a=i.value?.page,h=i.value?.toPage;return!a||typeof a!="string"||!h||typeof h!="string"?(console.warn("Invalid link entry:",i),!1):e(a)&&e(h)}catch(a){return console.error("Error processing link entry:",i,a),!1}}).map(i=>({source:i.value.page,target:i.value.toPage}));console.log("links filtered");let g={nodes:n.map(i=>({id:i.name,title:i.name,tags:i.tags,created:i.created,lastModified:i.lastModified})),links:l};console.log("Generated graph data:",JSON.stringify(g,null,2)),await p.set(["graph","main"],g),console.log("Graph saved to datastore:",g),await u.flashNotification("Graph saved to datastore!")}async function W(){await p.del(["graph","main"]),await u.flashNotification("Graph data cleared from datastore!")}async function L(e,t){let o=await p.get(["graph","main"]);return o?{html:'<div id="graph-container" style="width: 100%; height: 500px; border: 1px solid #ccc;"></div>',script:`
      loadJsByUrl("https://d3js.org/d3.v7.min.js").then(() => {
        ${await y.readAsset("graph","assets/graph_widget.js")}
        renderGraph(${JSON.stringify(o)});
      });
    `}:{html:"<div>Graph data not found in datastore. Please save a graph first!</div>"}}async function T(){await u.flashNotification("Hello world!")}var D={saveGraph:M,clearGraphData:W,graphWidget:L,hello:T},Q={name:"graph",version:.1,imports:["https://get.silverbullet.md/global.plug.json"],assets:{"assets/graph_widget.js":{data:"data:application/javascript;base64,ZnVuY3Rpb24gcmVuZGVyR3JhcGgoZ3JhcGhEYXRhKSB7CiAgY29uc3Qgd2lkdGggPSA2MDAsIGhlaWdodCA9IDQwMDsKCiAgLy8gQ3JlYSBsJ1NWRwogIGNvbnN0IHN2ZyA9IGQzLnNlbGVjdCgiI2dyYXBoLWNvbnRhaW5lciIpCiAgICAuYXBwZW5kKCJzdmciKQogICAgLmF0dHIoIndpZHRoIiwgd2lkdGgpCiAgICAuYXR0cigiaGVpZ2h0IiwgaGVpZ2h0KTsKCiAgLy8gU2ltdWxhemlvbmUgZGkgbGF5b3V0CiAgY29uc3Qgc2ltdWxhdGlvbiA9IGQzLmZvcmNlU2ltdWxhdGlvbihncmFwaERhdGEubm9kZXMpCiAgICAuZm9yY2UoImxpbmsiLCBkMy5mb3JjZUxpbmsoZ3JhcGhEYXRhLmxpbmtzKS5pZCgoZCkgPT4gZC5pZCkuZGlzdGFuY2UoMTAwKSkKICAgIC5mb3JjZSgiY2hhcmdlIiwgZDMuZm9yY2VNYW55Qm9keSgpLnN0cmVuZ3RoKC0zMDApKQogICAgLmZvcmNlKCJjZW50ZXIiLCBkMy5mb3JjZUNlbnRlcih3aWR0aCAvIDIsIGhlaWdodCAvIDIpKTsKCiAgLy8gRGlzZWduYSBpIGxpbmsKICBjb25zdCBsaW5rID0gc3ZnLmFwcGVuZCgiZyIpCiAgICAuc2VsZWN0QWxsKCJsaW5lIikKICAgIC5kYXRhKGdyYXBoRGF0YS5saW5rcykKICAgIC5qb2luKCJsaW5lIikKICAgIC5hdHRyKCJzdHJva2UiLCAiIzk5OSIpCiAgICAuYXR0cigic3Ryb2tlLXdpZHRoIiwgMik7CgogIC8vIERpc2VnbmEgaSBub2RpCiAgY29uc3Qgbm9kZSA9IHN2Zy5hcHBlbmQoImciKQogICAgLnNlbGVjdEFsbCgiY2lyY2xlIikKICAgIC5kYXRhKGdyYXBoRGF0YS5ub2RlcykKICAgIC5qb2luKCJjaXJjbGUiKQogICAgLmF0dHIoInIiLCAxMCkKICAgIC5hdHRyKCJmaWxsIiwgKGQpID0+IGQuZ3JvdXAgPT09IDEgPyAiYmx1ZSIgOiAiZ3JlZW4iKQogICAgLmNhbGwoCiAgICAgIGQzLmRyYWcoKQogICAgICAgIC5vbigic3RhcnQiLCAoZXZlbnQsIGQpID0+IHsKICAgICAgICAgIGlmICghZXZlbnQuYWN0aXZlKSBzaW11bGF0aW9uLmFscGhhVGFyZ2V0KDAuMykucmVzdGFydCgpOwogICAgICAgICAgZC5meCA9IGQueDsKICAgICAgICAgIGQuZnkgPSBkLnk7CiAgICAgICAgfSkKICAgICAgICAub24oImRyYWciLCAoZXZlbnQsIGQpID0+IHsKICAgICAgICAgIGQuZnggPSBldmVudC54OwogICAgICAgICAgZC5meSA9IGV2ZW50Lnk7CiAgICAgICAgfSkKICAgICAgICAub24oImVuZCIsIChldmVudCwgZCkgPT4gewogICAgICAgICAgaWYgKCFldmVudC5hY3RpdmUpIHNpbXVsYXRpb24uYWxwaGFUYXJnZXQoMCk7CiAgICAgICAgICBkLmZ4ID0gbnVsbDsKICAgICAgICAgIGQuZnkgPSBudWxsOwogICAgICAgIH0pLAogICAgKTsKCiAgLy8gQWdnaW9ybmEgcG9zaXppb25pCiAgc2ltdWxhdGlvbi5vbigidGljayIsICgpID0+IHsKICAgIGxpbmsKICAgICAgLmF0dHIoIngxIiwgKGQpID0+IGQuc291cmNlLngpCiAgICAgIC5hdHRyKCJ5MSIsIChkKSA9PiBkLnNvdXJjZS55KQogICAgICAuYXR0cigieDIiLCAoZCkgPT4gZC50YXJnZXQueCkKICAgICAgLmF0dHIoInkyIiwgKGQpID0+IGQudGFyZ2V0LnkpOwoKICAgIG5vZGUKICAgICAgLmF0dHIoImN4IiwgKGQpID0+IGQueCkKICAgICAgLmF0dHIoImN5IiwgKGQpID0+IGQueSk7CiAgfSk7Cn0K",mtime:1732060454981}},functions:{saveGraph:{path:"graph.ts:saveGraph",command:{name:"Save Graph"}},clearGraphData:{path:"graph.ts:clearGraphData",command:{name:"Clear Graph Data"}},graphWidget:{path:"graph.ts:widget",codeWidget:"graph"},hello:{path:"hello.ts:hello",command:{name:"hello"}}}},ur={manifest:Q,functionMapping:D};b(D,Q);export{ur as plug};
